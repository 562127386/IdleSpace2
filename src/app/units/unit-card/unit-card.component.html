<nz-card
  style="width: 100%;"
  nzSize="small"
  [nzTitle]="cardTitleTemplate"
  [nzExtra]="extraTemplate"
  [nzActions]="
    unit.modStack && unit.maxMods.gt(0)
      ? [buyOne, buyMax, mod]
      : building && building.maxDepartments > 0
      ? [buyOne, buyMax, dep]
      : [buyOne, buyMax]
  "
>
  <div *ngIf="unit.production.length > 0">
    <nz-slider
      [(ngModel)]="unit.operativity"
      [nzDisabled]="sliderDisabled"
      [nzStep]="0.1"
    ></nz-slider>

    <!-- Priority -->
    <div
      class="priority"
      fxLayout="row"
      fxLayoutGap="4px"
      *ngIf="ms.game.resourceManager.components.unlocked"
      fxLayoutAlign="center"
    >
      <span
        nz-popover
        nzPopoverTitle="Assembly Priority"
        [nzPopoverContent]="priorityTemplate"
        >Priority:
      </span>

      <ng-template #priorityTemplate>
        <p>
          Priorities for assembling new drones.<br />
          The first item is the normal priority,<br />the second is used when
          resources are ending.
        </p>
      </ng-template>

      <nz-input-group nzCompact>
        <nz-input-number
          [(ngModel)]="unit.assemblyPriority"
          [nzSize]="'small'"
          [nzMin]="0"
          [nzMax]="1e3"
          [nzStep]="1"
        ></nz-input-number>
        <nz-input-number
          [(ngModel)]="unit.assemblyPriorityEnding"
          [nzSize]="'small'"
          [nzMin]="0"
          [nzMax]="1e3"
          [nzStep]="1"
        ></nz-input-number>
      </nz-input-group>
    </div>
  </div>

  <!-- AutoBuy -->
  <div *ngIf="building?.autoBuyer" class="autoBuy">
    <form nz-form nzLayout="inline">
      <nz-form-item>
        <nz-form-label
          nz-popover
          nzPopoverTitle="Automation"
          [nzPopoverContent]="autoInfoTemplate"
          >Auto
        </nz-form-label>
        <nz-input-group nzCompact>
          <nz-select
            [(ngModel)]="building.autoBuyer.autoBuyType"
            nzSize="small"
            class="autoType"
            [name]="building.id + 'B'"
            (ngModelChange)="buildingAutoBuyChange()"
          >
            <nz-option
              nzLabel="Off"
              [nzValue]="BuildingAutoBuyTypes.OFF"
            ></nz-option>
            <nz-option
              nzLabel="Asap"
              [nzValue]="BuildingAutoBuyTypes.ASAP"
            ></nz-option>
            <nz-option
              nzLabel="As need"
              [nzValue]="BuildingAutoBuyTypes.AS_NEED"
            ></nz-option>
          </nz-select>
          <nz-select
            nzSize="small"
            class="autoTime"
            [(ngModel)]="building.autoBuyer.interval"
            [name]="building.id + 'C'"
          >
            <nz-option
              *ngFor="let interval of INTERVALS; trackBy: getIntervalId"
              [nzLabel]="interval.label"
              [nzValue]="interval.value"
            ></nz-option>
          </nz-select>
          <nz-input-number
            nzSize="small"
            [name]="building.id + 'P'"
            [(ngModel)]="building.autoBuyer.priority"
          ></nz-input-number>
        </nz-input-group>
      </nz-form-item>
    </form>
  </div>

  <ng-template #autoInfoTemplate>
    <p>
      Set auto buy options, last is priority (bigger number => high priority)
    </p>
  </ng-template>
</nz-card>

<ng-template #extraTemplate>
  <span class="infoIcon" *ngIf="unit.production.length > 0">
    <span
      nz-popover
      [nzPopoverContent]="contentTemplate"
      [nzPopoverTrigger]="popoverTrigger"
      (click)="createModal(contentTemplate, tplFooter)"
    >
      <!-- [nzPopoverTitle]="titleTemplate" -->
      <i nz-icon nzType="info-circle" nzTheme="outline"></i>
    </span>
  </span>
</ng-template>

<ng-template #cardTitleTemplate>
  <nz-card-meta
    [nzAvatar]="avatarTemplate"
    [nzTitle]="title"
    [nzDescription]="description"
    nz-popover
    [nzPopoverContent]="limitPopover"
  ></nz-card-meta>
</ng-template>
<ng-template #avatarTemplate>
  <i nz-icon [nzType]="unit.icon" [ngClass]="unit.colorClass"></i>
</ng-template>
<ng-template #title>
  <span> {{ unit.name }}</span>
</ng-template>
<ng-template #description>
  <span class="monospace">
    {{ unit.quantity | format: true }}
    <!-- ({{ unit.manualBought | format }}) -->
    <span *ngIf="unit.limit.lt(Decimal.MAX_VALUE)">
      /
      {{ unit.limit | format: true }}
    </span>
  </span>
</ng-template>

<ng-template #titleTemplate>
  <i nz-icon nzType="table"></i> Production</ng-template
>

<!-- Production Table -->
<ng-template #contentTemplate>
  <app-prod-table [unit]="unit"></app-prod-table>
</ng-template>

<ng-template #priceTemplateOne>
  <app-prices [unit]="unit" [quantity]="ONE"></app-prices>
</ng-template>
<ng-template #priceTemplateMax>
  <app-prices [unit]="unit" [quantity]="customBuy"></app-prices>
</ng-template>

<!-- Buttons -->
<ng-template #buyOne>
  <div
    *ngIf="unit.buyPrice.canBuy; else buyOneDisabled"
    nz-popover
    [nzPopoverContent]="priceTemplateOne"
    nzPopoverTrigger="hover"
    nzPopoverPlacement="bottom"
    (click)="buyOneAct()"
  >
    <span>
      Buy &nbsp;
      <span class="monospace">1</span>
    </span>
  </div>
</ng-template>

<ng-template #buyOneDisabled>
  <div
    nz-popover
    [nzPopoverContent]="priceTemplateOne"
    nzPopoverTrigger="hover"
    nzPopoverPlacement="bottom"
    nz-typography
    nzDisabled
  >
    <span>
      Buy &nbsp;
      <span class="monospace">1</span>
    </span>
  </div>
</ng-template>

<ng-template #buyMax>
  <div
    *ngIf="unit.buyPrice.canBuy; else buyMaxDisabled"
    nz-popover
    [nzPopoverContent]="priceTemplateMax"
    nzPopoverTrigger="hover"
    nzPopoverPlacement="bottom"
    (click)="buyCustom()"
  >
    <span>
      Buy &nbsp;<span class="monospace">{{ customBuy | format: true }}</span>
    </span>
  </div>
</ng-template>
<ng-template #buyMaxDisabled>
  <div
    nz-popover
    [nzPopoverContent]="priceTemplateMax"
    nzPopoverTrigger="hover"
    nzPopoverPlacement="bottom"
    nz-typography
    nzDisabled
  >
    <span>
      Buy &nbsp;<span class="monospace">{{ customBuy | format: true }}</span>
    </span>
  </div>
</ng-template>

<ng-template #tplFooter>
  <button nz-button nzType="primary" (click)="destroyTplModal()" nzSize="small">
    Ok
  </button>
</ng-template>
<ng-template #mod>
  <div (click)="goModPage()">
    <i nz-icon nzType="fa-s:microchip"></i>
    <span class="monospace">
      {{ unit.modStack.used | format: true }} /{{
        unit.maxMods | format: true
      }}</span
    >
  </div>
</ng-template>
<ng-template #dep>
  <div *ngIf="building" (click)="goDepPage()">
    <i nz-icon nzType="fa-s:microchip"></i>
    <span class="monospace">
      {{ building.usedDepartments | format: true }} /{{
        building.maxDepartments | format: true
      }}</span
    >
  </div>
</ng-template>

<ng-template #limitPopover>
  <p *ngIf="unit.description !== ''">{{ unit.description }}</p>
  <div *ngIf="unit.limitStack">
    <h4>Storage - Additive</h4>
    <nz-table nzTemplateMode nzSize="middle">
      <tbody>
        <tr *ngFor="let limit of unit.limitStack?.bonuses; trackBy: getBonusId">
          <ng-container
            *ngIf="
              limit.unit.quantity.gt(0) &&
              (!limit.secondMultiplier ||
                limit.secondMultiplier?.quantity.gt(0))
            "
          >
            <td>
              {{ limit.unit.name }}
              <span *ngIf="limit.secondMultiplier">{{
                limit.secondMultiplier.name
              }}</span>
            </td>
            <td>
              <span *ngIf="!limit.secondMultiplier; else secondMulti">{{
                limit.unit.quantity | format
              }}</span>
              <ng-template #secondMulti>
                <span>{{
                  limit.unit.quantity.times(limit.secondMultiplier.quantity)
                    | format
                }}</span>
              </ng-template>
            </td>
            <td>x{{ limit.multiplier | format: true }}</td>
            <td>
              = {{ limit.unit.quantity.times(limit.multiplier) | format }}
            </td>
          </ng-container>
        </tr>
      </tbody>
    </nz-table>
    <h4>Storage - Multiplicative</h4>
    <nz-table nzTemplateMode nzSize="middle">
      <tbody>
        <tr
          *ngFor="
            let limit of unit.limitStackMulti?.bonuses;
            trackBy: getBonusId
          "
        >
          <ng-container *ngIf="limit.unit.quantity.gt(0)">
            <td>{{ limit.unit.name }}</td>
            <td>{{ limit.unit.quantity | format }}</td>
            <td>x{{ limit.multiplier.times(100) | format }}%</td>
            <td>
              = x{{
                limit.unit.quantity.times(limit.multiplier).times(100) | format
              }}%
            </td>
          </ng-container>
        </tr>
      </tbody>
    </nz-table>
  </div>
</ng-template>
